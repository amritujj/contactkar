<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Dashboard - ContactKar</title>
  <link rel="stylesheet" href="styles_v2.css"/>
  <link rel="stylesheet" href="globalanimations.css"/>
  <style>
    /* ===== DASHBOARD-SPECIFIC STYLES ===== */
    :root {
      --primary: #2563eb; --primary-dark: #1e40af;
      --pet-color: #ec4899; --pet-dark: #db2777;
      --success: #10b981; --danger: #ef4444;
      --border: #e5e7eb; --text-dark: #1f2937;
      --text-light: #6b7280; --bg-light: #f5f7fb;
    }

    /* Tab animation */
    .tab-section { display: none; }
    .tab-section.active-tab { display: block; animation: tabFadeIn .3s ease both; }
    @keyframes tabFadeIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }

    /* Page header row */
    .page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; flex-wrap:wrap; gap:.8rem; }
    .page-header h2 { font-size:1.4rem; font-weight:800; color:#111827; margin:0; }

    /* Panel card */
    .panel { background:#fff; padding:1.5rem; border-radius:14px; border:1px solid var(--border); margin-bottom:1rem; box-shadow:0 1px 4px rgba(0,0,0,.04); transition:box-shadow .25s,transform .25s; }
    .panel:hover { box-shadow:0 6px 22px rgba(0,0,0,.08); transform:translateY(-2px); }

    /* Empty state */
    .empty-block { border:2px dashed #d1d5db; background:#fff; border-radius:14px; padding:2.5rem 1.5rem; text-align:center; color:var(--text-light); margin-bottom:1rem; }
    .empty-block .empty-icon { font-size:2.8rem; margin-bottom:.7rem; }
    .empty-block h3 { color:#111827; font-size:1.05rem; margin-bottom:.4rem; }
    .empty-block p { font-size:.875rem; margin-bottom:1rem; }

    /* Tag card */
    .tag-card {
      background:#fff; border:1px solid var(--border); border-radius:14px;
      padding:1.2rem 1.4rem; margin-bottom:.9rem;
      display:flex; gap:1rem; align-items:flex-start; flex-wrap:wrap;
      transition:box-shadow .25s,border-color .25s,transform .25s;
      animation:tagSlideIn .4s ease both;
    }
    .tag-card:hover { box-shadow:0 8px 28px rgba(37,99,235,.13); border-color:#93c5fd; transform:translateY(-2px); }
    @keyframes tagSlideIn { from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);} }

    /* QR box */
    .qr-box {
      width:90px; height:90px; min-width:90px;
      border-radius:10px; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      font-size:11px; color:#9ca3af; text-align:center;
      background: linear-gradient(135deg,#f3f4f6,#e9eaec);
    }
    .qr-box img { width:90px; height:90px; border-radius:10px; cursor:pointer; display:block; transition:transform .2s; }
    .qr-box img:hover { transform:scale(1.06); }
    .qr-shimmer {
      width:90px; height:90px; border-radius:10px;
      background:linear-gradient(90deg,#f3f4f6 25%,#e0e1e3 50%,#f3f4f6 75%);
      background-size:200% 100%;
      animation:shimmerAnim 1.4s infinite;
    }
    @keyframes shimmerAnim { 0%{background-position:-200% 0}100%{background-position:200% 0} }

    /* Tag info */
    .tag-info { flex:1; min-width:160px; }
    .tag-code-row { display:flex; align-items:center; gap:6px; flex-wrap:wrap; margin-bottom:7px; }
    .tag-code-text { font-size:1rem; font-weight:800; color:#111827; letter-spacing:.4px; }
    .badge { display:inline-block; padding:2px 10px; border-radius:20px; font-size:11px; font-weight:700; white-space:nowrap; }
    .badge-vehicle { background:#dbeafe; color:#1d4ed8; }
    .badge-pet     { background:#fce7f3; color:#be185d; }
    .badge-active  { background:#d1fae5; color:#065f46; }
    .badge-hidden  { background:#fee2e2; color:#991b1b; }
    .tag-meta { font-size:13px; color:#4b5563; margin-bottom:3px; }
    .tag-date { font-size:11px; color:#9ca3af; margin:5px 0 10px; }

    /* Tag action buttons */
    .tag-actions { display:flex; gap:6px; flex-wrap:wrap; }
    .act-btn { padding:5px 13px; border-radius:7px; font-size:12px; font-weight:600; cursor:pointer; transition:all .18s; border:1.5px solid; }
    .act-btn-primary { background:#2563eb; color:#fff; border-color:#2563eb; }
    .act-btn-primary:hover { background:#1d4ed8; }
    .act-btn-outline { background:#fff; color:#374151; border-color:#d1d5db; }
    .act-btn-outline:hover { background:#f3f4f6; border-color:#9ca3af; }

    /* Loading spinner */
    .loading-wrap { text-align:center; padding:3rem 1rem; }
    .spinner { width:38px; height:38px; border:3px solid #e5e7eb; border-top-color:#2563eb; border-radius:50%; animation:spin .7s linear infinite; margin:0 auto 1rem; }
    @keyframes spin { to{transform:rotate(360deg)} }
    .loading-text { color:var(--text-light); font-size:.9rem; line-height:1.7; }

    /* Forms */
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:1.2rem; margin-bottom:1.2rem; }
    .form-group { margin-bottom:1.1rem; }
    .form-group label { display:block; font-weight:600; font-size:.875rem; color:#374151; margin-bottom:.4rem; }
    .form-control { width:100%; padding:.72rem .9rem; border:1.5px solid #d1d5db; border-radius:8px; font-size:.95rem; color:#111827; transition:border-color .2s,box-shadow .2s; outline:none; font-family:inherit; }
    .form-control:focus { border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.12); }
    .email-display { display:flex; justify-content:space-between; align-items:center; background:#f9fafb; border:1.5px solid #e5e7eb; border-radius:8px; padding:.65rem .9rem; }

    /* OTP flow */
    .otp-box { background:#fdf2f8; border:1.5px solid #f9a8d4; border-radius:10px; padding:1.2rem 1.4rem; margin-bottom:1.2rem; }
    .otp-box h4 { color:#be185d; margin-bottom:.6rem; font-size:.95rem; }

    /* Billing plan card */
    .plan-card { background:linear-gradient(135deg,#eff6ff,#dbeafe); border:2px solid #93c5fd; border-radius:14px; padding:1.2rem 1.5rem; display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; gap:1rem; flex-wrap:wrap; animation:tabFadeIn .4s ease; }
    .plan-name { font-size:1.2rem; font-weight:800; color:#1d4ed8; }
    .plan-expiry { font-size:13px; color:var(--text-light); margin-top:3px; }

    /* Order panel */
    .order-panel { background:#fff; border:1px solid var(--border); border-radius:14px; padding:1.4rem 1.5rem; margin-top:1.2rem; }
    .order-panel h3 { font-size:1.05rem; font-weight:700; margin-bottom:.4rem; }
    .offer-box { background:#fefce8; border-left:4px solid #f59e0b; padding:.7rem 1rem; border-radius:6px; font-size:.875rem; margin:.9rem 0; color:#78350f; }
    .qty-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin:.9rem 0; }
    .qty-grid label { font-weight:600; font-size:.875rem; display:block; margin-bottom:4px; color:#374151; }
    .addr-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:.5rem; margin-bottom:.9rem; }
    .price-box { background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:.9rem 1rem; margin-bottom:1rem; font-size:.9rem; line-height:1.9; }
    .price-box strong { color:#2563eb; font-size:1rem; }

    /* Settings toggle row */
    .toggle-row { display:flex; justify-content:space-between; align-items:center; padding:1rem 0; border-bottom:1px solid #f3f4f6; }
    .toggle-row:last-child { border-bottom:none; }
    .toggle-label strong { display:block; font-weight:600; font-size:.9rem; }
    .toggle-label span { font-size:.8rem; color:var(--text-light); }
    .switch { position:relative; display:inline-block; width:48px; height:24px; flex-shrink:0; }
    .switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; cursor:pointer; inset:0; background:#d1d5db; transition:.3s; border-radius:34px; }
    .slider::before { position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background:#fff; transition:.3s; border-radius:50%; box-shadow:0 1px 3px rgba(0,0,0,.2); }
    input:checked + .slider { background:var(--success); }
    input:checked + .slider::before { transform:translateX(22px); }

    /* Danger zone */
    .danger-zone { border:1.5px solid #fca5a5; border-radius:12px; padding:1.4rem; background:#fef2f2; margin-top:1rem; }
    .danger-zone h3 { color:var(--danger); margin-bottom:.4rem; font-size:1rem; }
    .danger-zone p { font-size:.875rem; color:#991b1b; margin-bottom:.9rem; }

    /* QR modal */
    .qr-modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9999; align-items:center; justify-content:center; }
    .qr-modal-overlay.open { display:flex; }
    .qr-modal-box { background:#fff; border-radius:18px; padding:2rem; max-width:320px; width:90%; text-align:center; box-shadow:0 24px 60px rgba(0,0,0,.3); animation:tabFadeIn .3s ease; }
    .qr-modal-box h3 { font-size:1rem; font-weight:700; margin-bottom:3px; }
    .qr-modal-box p { color:var(--text-light); font-size:13px; margin-bottom:14px; }
    .qr-modal-box img { width:210px; height:210px; border-radius:12px; border:4px solid #f3f4f6; }
    .qr-modal-btns { display:flex; gap:10px; justify-content:center; margin-top:1rem; flex-wrap:wrap; }

    /* Sidebar stagger */
    .sidebar ul li:nth-child(1) a { animation-delay:.05s; }
    .sidebar ul li:nth-child(2) a { animation-delay:.12s; }
    .sidebar ul li:nth-child(3) a { animation-delay:.19s; }
    .sidebar ul li:nth-child(4) a { animation-delay:.26s; }

    /* Responsive */
    @media(max-width:768px){
      .form-row, .qty-grid { grid-template-columns:1fr; }
      .addr-grid { grid-template-columns:1fr; }
      .tag-card { flex-direction:column; }
      .qr-box, .qr-box img, .qr-shimmer { width:100%; height:auto; min-height:80px; min-width:unset; }
      .plan-card { flex-direction:column; text-align:center; }
      .page-header { flex-direction:column; align-items:flex-start; }
    }
  </style>

  <script>
    // Redirect to login if not logged in
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      window.location.href = 'login.html';
    }
  </script>
</head>
<body>

<!-- ===== NAVBAR ===== -->
<nav class="navbar anim-fade-down">
  <div class="container">
    <a href="index.html" class="nav-brand">Contact<span>Kar</span></a>
    <div style="display:flex;align-items:center;gap:1rem;">
      <span style="font-weight:600;color:#374151;" id="user-greeting">Hi, User üëã</span>
      <button onclick="logout()" style="padding:6px 16px;border:1.5px solid #e5e7eb;border-radius:8px;background:#fff;font-weight:600;font-size:.85rem;cursor:pointer;transition:all .2s;"
        onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#fff'">Logout</button>
    </div>
  </div>
</nav>

<!-- ===== QR MODAL ===== -->
<div id="qrModalOverlay" class="qr-modal-overlay" onclick="if(event.target===this)closeQRModal()">
  <div class="qr-modal-box">
    <h3 id="qrMTitle"></h3>
    <p>Scan to open your contact page</p>
    <img id="qrMImg" src="" alt="QR Code"/>
    <div class="qr-modal-btns">
      <a id="qrMDownload" download class="btn btn-primary" style="font-size:13px;padding:8px 18px;">‚¨á Download PNG</a>
      <button onclick="closeQRModal()" class="btn btn-outline" style="font-size:13px;padding:8px 18px;">‚úï Close</button>
    </div>
  </div>
</div>

<!-- ===== DASHBOARD LAYOUT ===== -->
<div class="container">
  <div class="dashboard-grid">

    <!-- SIDEBAR -->
    <aside class="sidebar anim-fade-left">
      <ul>
        <li><a href="#" id="nav-tags"     class="active anim-fade-left" onclick="switchTab('tags');return false;">üì¶ My Tags</a></li>
        <li><a href="#" id="nav-profile"           class="anim-fade-left" onclick="switchTab('profile');return false;">üë§ Profile</a></li>
        <li><a href="#" id="nav-billing"            class="anim-fade-left" onclick="switchTab('billing');return false;">üí≥ Billing</a></li>
        <li><a href="#" id="nav-settings"           class="anim-fade-left" onclick="switchTab('settings');return false;">‚öôÔ∏è Settings</a></li>
      </ul>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">

      <!-- ============ MY TAGS ============ -->
      <section id="tags-section" class="tab-section active-tab">
        <div class="page-header">
          <h2>üì¶ My Tags</h2>
          <a href="vehicle.html" class="btn btn-primary">+ Buy Tag</a>
        </div>

        <!-- Loading state -->
        <div id="tags-loading" class="loading-wrap">
          <div class="spinner"></div>
          <div class="loading-text" id="loading-msg">
            Connecting to server...<br>
            <small style="color:#9ca3af;">May take ~15s if server was sleeping</small>
          </div>
          <button onclick="fetchMyTags()" style="margin-top:12px;padding:7px 18px;background:#2563eb;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:.85rem;">üîÑ Retry</button>
        </div>

        <!-- Empty state -->
        <div id="tags-empty" class="empty-block" style="display:none;">
          <div class="empty-icon">üõí</div>
          <h3>No tags yet</h3>
          <p>Buy a Vehicle Tag or Pet Tag to get started.</p>
          <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
            <a href="vehicle.html" class="btn btn-primary">üöó Get Vehicle Tag</a>
            <a href="pet.html" class="btn btn-pet">üêæ Get Pet Tag</a>
          </div>
        </div>

        <!-- Tags list -->
        <div id="tags-list"></div>
      </section>

      <!-- ============ PROFILE ============ -->
      <section id="profile-section" class="tab-section">
        <div class="page-header"><h2>üë§ Profile</h2></div>

        <div class="panel">
          <!-- Email display -->
          <div class="form-group" style="padding-bottom:1.2rem;margin-bottom:1.2rem;border-bottom:1px solid #f3f4f6;">
            <label>Login Email Address</label>
            <div class="email-display">
              <span id="display-email" style="font-weight:700;">Loading...</span>
              <button class="btn btn-outline" style="font-size:.8rem;padding:5px 12px;" onclick="openEmailOTPFlow()">Change</button>
            </div>
            <small style="color:#9ca3af;margin-top:5px;display:block;">Used for login, OTPs, and notifications.</small>
          </div>

          <!-- OTP Flow (hidden by default) -->
          <div id="otp-flow" style="display:none;" class="otp-box">
            <h4>üîê Verify Your Identity</h4>

            <!-- Step 1: Send OTP -->
            <div id="otp-step-1">
              <p style="font-size:.875rem;color:#4b5563;margin-bottom:10px;">
                An OTP will be sent to: <b id="otp-target-email"></b>
              </p>
              <button id="send-otp-btn" class="btn btn-primary" onclick="sendRealOTP()">Send OTP</button>
            </div>

            <!-- Step 2: Enter OTP -->
            <div id="otp-step-2" style="display:none;">
              <div class="form-group">
                <label>Enter 6-digit OTP</label>
                <input type="text" id="otp-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" class="form-control"
                  style="letter-spacing:6px;font-weight:700;text-align:center;font-size:1.2rem;">
              </div>
              <button class="btn btn-primary" onclick="verifyOTP()">Verify Code</button>
            </div>

            <!-- Step 3: Enter new email -->
            <div id="otp-step-3" style="display:none;">
              <p style="color:var(--success);font-weight:700;margin-bottom:10px;">‚úÖ Identity Verified!</p>
              <div class="form-group">
                <label>Enter New Email Address</label>
                <input type="email" id="new-email-input" placeholder="new@example.com" class="form-control">
              </div>
              <button class="btn btn-primary" onclick="saveNewEmail()">Update Email</button>
            </div>

            <button onclick="cancelEmailFlow()" style="margin-top:12px;background:none;border:none;color:var(--text-light);font-size:.85rem;cursor:pointer;">‚úï Cancel</button>
          </div>

          <!-- Profile form -->
          <form onsubmit="saveProfile(event)">
            <div class="form-row">
              <div class="form-group">
                <label>Full Name</label>
                <input id="profile-name" type="text" class="form-control" placeholder="Your name" required/>
              </div>
              <div class="form-group">
                <label>Phone Number</label>
                <input id="profile-phone" type="tel" class="form-control" placeholder="+91 98765 43210"/>
              </div>
            </div>
            <button class="btn btn-primary" type="submit" id="profile-save-btn">Save Changes</button>
            <span id="profile-save-msg" style="margin-left:10px;color:var(--success);font-weight:600;font-size:.875rem;"></span>
          </form>
        </div>
      </section>

      <!-- ============ BILLING ============ -->
      <section id="billing-section" class="tab-section">
        <div class="page-header"><h2>üí≥ Billing</h2></div>

        <!-- Active plan (shown when subscribed) -->
        <div id="plan-card" style="display:none;" class="plan-card">
          <div>
            <div class="plan-name" id="plan-name-display">Basic Plan</div>
            <div class="plan-expiry" id="plan-expiry-display">Valid until --</div>
          </div>
          <a href="vehicle.html" class="btn btn-primary">‚¨Ü Upgrade</a>
        </div>

        <!-- No plan (shown on free tier) -->
        <div id="no-plan" class="empty-block">
          <div class="empty-icon">üßæ</div>
          <h3>No active subscription</h3>
          <p>You are on the free plan. Upgrade to unlock more tags and features.</p>
          <a href="vehicle.html" class="btn btn-primary">Choose a Plan</a>
        </div>

        <!-- Hard Copy Order -->
        <div class="order-panel">
          <h3>üñ®Ô∏è Order Hard Copy Tags</h3>
          <p style="color:var(--text-light);font-size:.875rem;margin-top:4px;">Get physical PVC sticker / locket tags delivered. ‚Çπ149 per delivery.</p>

          <div class="offer-box">
            üî• <strong>Bulk Offer:</strong>&nbsp; Order 3 tags ‚Üí 1 delivery FREE &nbsp;|&nbsp; Order 5 tags ‚Üí 2 deliveries FREE
          </div>

          <div class="qty-grid">
            <div>
              <label>üöó Vehicle Tags</label>
              <input type="number" id="vehicleQty" min="0" value="0" class="form-control" oninput="calculateTotal()">
            </div>
            <div>
              <label>üêæ Pet Tags</label>
              <input type="number" id="petQty" min="0" value="0" class="form-control" oninput="calculateTotal()">
            </div>
          </div>

          <h4 style="font-size:.9rem;font-weight:700;margin-bottom:.6rem;color:#374151;">üì¶ Shipping Address</h4>
          <input type="text" id="address" placeholder="Street Address" class="form-control" style="margin-bottom:.5rem;">
          <div class="addr-grid">
            <input type="text" id="city"    placeholder="City"    class="form-control">
            <input type="text" id="state"   placeholder="State"   class="form-control">
            <input type="text" id="pincode" placeholder="Pincode" class="form-control">
          </div>

          <div class="price-box">
            <div>Total Tags: <strong id="totalTagsDisplay">0</strong></div>
            <div>Delivery Cost: <strong id="costDisplay">‚Çπ0</strong>
              <span id="savingsDisplay" style="color:#dc2626;font-size:12px;font-weight:700;margin-left:6px;"></span>
            </div>
          </div>

          <button onclick="placeOrder()" class="btn btn-primary" style="width:100%;justify-content:center;padding:.9rem;font-size:1rem;">Proceed to Pay</button>
        </div>
      </section>

      <!-- ============ SETTINGS ============ -->
      <section id="settings-section" class="tab-section">
        <div class="page-header"><h2>‚öôÔ∏è Settings</h2></div>

        <div class="panel">
          <h3 style="font-size:1rem;font-weight:700;margin-bottom:.6rem;">üîî Notifications</h3>

          <div class="toggle-row">
            <div class="toggle-label">
              <strong>Email Alerts</strong>
              <span>Get an email whenever someone scans your tag</span>
            </div>
            <label class="switch"><input type="checkbox" id="toggle-email" checked><span class="slider"></span></label>
          </div>

          <div class="toggle-row">
            <div class="toggle-label">
              <strong>WhatsApp / SMS Alerts</strong>
              <span>Get a WhatsApp or SMS message on every scan</span>
            </div>
            <label class="switch"><input type="checkbox" id="toggle-whatsapp" checked><span class="slider"></span></label>
          </div>
        </div>

        <div class="danger-zone">
          <h3>‚ö†Ô∏è Danger Zone</h3>
          <p>Permanently deletes your account, all tags, and data. This action <strong>cannot be undone.</strong></p>
          <button class="btn btn-danger" onclick="confirmDelete()">Delete My Account</button>
        </div>
      </section>

    </main>
  </div>
</div>

<!-- ===== SCRIPTS ===== -->
<script src="nav_logic.js"></script>
<script src="animations.js"></script>
<script src="dashboard.js"></script>

<script>
// ================================================================
//  DASHBOARD CONTROLLER ‚Äî ContactKar
// ================================================================
const API_URL = 'https://contactkar.onrender.com/api';

// ---- QR Cache ----
const qrCache = {};

// ---- Tab Switching ----
function switchTab(tabId) {
  document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active-tab'));
  document.querySelectorAll('.sidebar ul li a').forEach(a => a.classList.remove('active'));
  document.getElementById(tabId + '-section').classList.add('active-tab');
  document.getElementById('nav-' + tabId).classList.add('active');
  if (tabId === 'billing') fetchBillingPlan();
}

// ---- Init: Load User Info ----
(function initUser() {
  const name  = localStorage.getItem('userName')  || 'User';
  const email = localStorage.getItem('userEmail') || 'Not Set';
  document.getElementById('user-greeting').innerText    = 'Hi, ' + name + ' üëã';
  document.getElementById('profile-name').value         = name;
  document.getElementById('profile-phone').value        = localStorage.getItem('userPhone') || '';
  document.getElementById('display-email').innerText    = email;
  document.getElementById('otp-target-email').innerText = email;
})();

// ---- Logout ----
function logout() {
  localStorage.clear();
  window.location.href = 'login.html';
}

// ---- Save Profile ----
function saveProfile(e) {
  e.preventDefault();
  const btn  = document.getElementById('profile-save-btn');
  const msg  = document.getElementById('profile-save-msg');
  const name = document.getElementById('profile-name').value.trim();
  const phone= document.getElementById('profile-phone').value.trim();
  btn.disabled = true;
  msg.textContent = 'Saving...';
  localStorage.setItem('userName',  name);
  localStorage.setItem('userPhone', phone);
  document.getElementById('user-greeting').innerText = 'Hi, ' + (name || 'User') + ' üëã';
  setTimeout(() => {
    btn.disabled = false;
    msg.textContent = '‚úÖ Saved!';
    setTimeout(() => msg.textContent = '', 2000);
  }, 400);
}

// ---- Email OTP Flow ----
function openEmailOTPFlow() {
  document.getElementById('otp-flow').style.display    = 'block';
  document.getElementById('otp-step-1').style.display  = 'block';
  document.getElementById('otp-step-2').style.display  = 'none';
  document.getElementById('otp-step-3').style.display  = 'none';
  document.getElementById('otp-input').value = '';
  document.getElementById('new-email-input').value = '';
}
function cancelEmailFlow() {
  document.getElementById('otp-flow').style.display = 'none';
}
async function sendRealOTP() {
  const btn = document.getElementById('send-otp-btn');
  btn.textContent = 'Sending...';
  btn.disabled    = true;
  try {
    const res  = await fetch(API_URL + '/auth/send-change-email-otp', {
      method: 'POST',
      headers: { Authorization: 'Bearer ' + localStorage.getItem('token') }
    });
    const data = await res.json();
    if (data.success) {
      document.getElementById('otp-step-1').style.display = 'none';
      document.getElementById('otp-step-2').style.display = 'block';
      document.getElementById('otp-input').focus();
      showToast('OTP sent! Check your email inbox.', 'success');
    } else {
      showToast('Failed: ' + data.error, 'error');
    }
  } catch(e) { showToast('Server error. Try again.', 'error'); }
  btn.textContent = 'Send OTP';
  btn.disabled    = false;
}
async function verifyOTP() {
  const otp   = document.getElementById('otp-input').value.trim();
  const token = localStorage.getItem('token');
  if (otp.length !== 6) { showToast('Please enter a 6-digit OTP.', 'error'); return; }
  try {
    const res  = await fetch(API_URL + '/auth/verify-change-email-otp', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
      body: JSON.stringify({ otp, newEmail: '' })
    });
    const data = await res.json();
    if (data.success || data.verified) {
      document.getElementById('otp-step-2').style.display = 'none';
      document.getElementById('otp-step-3').style.display = 'block';
    } else { showToast('Invalid OTP. Try again.', 'error'); }
  } catch(e) { showToast('Server error.', 'error'); }
}
async function saveNewEmail() {
  const otp      = document.getElementById('otp-input').value.trim();
  const newEmail = document.getElementById('new-email-input').value.trim();
  const token    = localStorage.getItem('token');
  if (!newEmail || !newEmail.includes('@')) { showToast('Enter a valid email address.', 'error'); return; }
  try {
    const res  = await fetch(API_URL + '/auth/verify-change-email-otp', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
      body: JSON.stringify({ otp, newEmail })
    });
    const data = await res.json();
    if (data.success) {
      localStorage.setItem('userEmail', newEmail);
      document.getElementById('display-email').innerText    = newEmail;
      document.getElementById('otp-target-email').innerText = newEmail;
      cancelEmailFlow();
      showToast('‚úÖ Email updated successfully!', 'success');
    } else { showToast('Error: ' + data.error, 'error'); }
  } catch(e) { showToast('Server error.', 'error'); }
}

// ---- QR Modal ----
function openQRModal(tagCode, src) {
  document.getElementById('qrMTitle').innerText     = tagCode;
  document.getElementById('qrMImg').src              = src;
  document.getElementById('qrMDownload').href        = src;
  document.getElementById('qrMDownload').download    = 'ContactKar-QR-' + tagCode + '.png';
  document.getElementById('qrModalOverlay').classList.add('open');
}
function closeQRModal() {
  document.getElementById('qrModalOverlay').classList.remove('open');
}
document.addEventListener('keydown', e => { if(e.key==='Escape') closeQRModal(); });

// ---- Load QR for one tag ----
async function loadQRCode(tagCode) {
  const box = document.getElementById('qr-' + tagCode);
  if (!box) return;
  if (qrCache[tagCode]) { renderQRImg(tagCode, qrCache[tagCode]); return; }
  try {
    const res  = await fetch(API_URL + '/tags/' + tagCode + '/qrcode', {
      headers: { Authorization: 'Bearer ' + localStorage.getItem('token') }
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (data.success && data.qr) {
      qrCache[tagCode] = data.qr;
      renderQRImg(tagCode, data.qr);
    } else { renderQRError(tagCode); }
  } catch(e) { renderQRError(tagCode); }
}

function renderQRImg(tagCode, src) {
  const box = document.getElementById('qr-' + tagCode);
  if (!box) return;
  box.innerHTML = '<img src="' + src + '" alt="QR Code" '
    + 'title="Click to enlarge" '
    + 'onclick="openQRModal('' + tagCode + '','' + src + '')">';
}

function renderQRError(tagCode) {
  const box = document.getElementById('qr-' + tagCode);
  if (!box) return;
  box.innerHTML =
    '<div style="text-align:center;font-size:11px;color:#ef4444;padding:6px;">'
    + '‚ö†Ô∏è Failed<br>'
    + '<button onclick="loadQRCode('' + tagCode + '')" '
    + 'style="margin-top:4px;padding:3px 9px;border:1px solid #ef4444;border-radius:5px;background:#fff;cursor:pointer;font-size:11px;color:#ef4444;">Retry</button>'
    + '</div>';
}

// ---- Copy scan link ----
function copyTagLink(tagCode) {
  const url = 'https://contactkar.vercel.app/tag/' + tagCode;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(url).then(() => showToast('üîó Scan link copied!', 'success'));
  } else { prompt('Copy this link:', url); }
}

// ---- Toggle tag contactable ----
async function toggleContact(tagId, newState) {
  const token = localStorage.getItem('token');
  try {
    const res  = await fetch(API_URL + '/tags/' + tagId + '/toggle', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
      body: JSON.stringify({ isContactable: newState })
    });
    const data = await res.json();
    if (data.success) { fetchMyTags(); showToast(newState ? 'üëÅ Tag is now visible.' : 'üôà Tag is now hidden.', 'success'); }
    else showToast('Failed: ' + data.error, 'error');
  } catch(e) { showToast('Network error. Try again.', 'error'); }
}

// ---- Wake up Render server ----
async function wakeUpServer() {
  try {
    const ctrl = new AbortController();
    setTimeout(() => ctrl.abort(), 9000);
    await fetch('https://contactkar.onrender.com/', { signal: ctrl.signal });
  } catch(e) { /* ignore ‚Äî just a wakeup ping */ }
}

// ---- Fetch & Render Tags ----
async function fetchMyTags() {
  const token   = localStorage.getItem('token');
  const list    = document.getElementById('tags-list');
  const loading = document.getElementById('tags-loading');
  const empty   = document.getElementById('tags-empty');
  const loadMsg = document.getElementById('loading-msg');

  list.innerHTML        = '';
  empty.style.display   = 'none';
  loading.style.display = 'block';
  loadMsg.innerHTML = 'Connecting to server...<br><small style="color:#9ca3af;">May take ~15s if server was sleeping</small>';

  if (!token) {
    loading.style.display = 'none';
    empty.style.display   = 'block';
    return;
  }

  // Wake up Render free tier
  await wakeUpServer();
  loadMsg.textContent = 'Loading your tags...';

  try {
    const ctrl = new AbortController();
    const timeout = setTimeout(() => ctrl.abort(), 22000);

    const res = await fetch(API_URL + '/tags/user', {
      headers: { Authorization: 'Bearer ' + token },
      signal: ctrl.signal
    });
    clearTimeout(timeout);

    if (res.status === 401) {
      localStorage.clear();
      window.location.href = 'login.html';
      return;
    }

    const data = await res.json();
    loading.style.display = 'none';

    if (!data.success || !data.tags || data.tags.length === 0) {
      empty.style.display = 'block';
      return;
    }

    // Render tag cards
    list.innerHTML = data.tags.map((tag, i) => {
      const typeBadge = tag.type === 'pet'
        ? '<span class="badge badge-pet">üêæ Pet</span>'
        : '<span class="badge badge-vehicle">üöó Vehicle</span>';
      const statusBadge = tag.is_contactable
        ? '<span class="badge badge-active">üü¢ Active</span>'
        : '<span class="badge badge-hidden">üî¥ Hidden</span>';

      return [
        '<div class="tag-card" style="animation-delay:' + (i * 0.08) + 's;">',
          '<div class="qr-box" id="qr-' + tag.tag_code + '">',
            '<div class="qr-shimmer"></div>',
          '</div>',
          '<div class="tag-info">',
            '<div class="tag-code-row">',
              '<span class="tag-code-text">' + tag.tag_code + '</span>',
              typeBadge, statusBadge,
            '</div>',
            (tag.vehicle_number    ? '<div class="tag-meta">üöó <b>' + tag.vehicle_number + '</b></div>' : ''),
            (tag.owner_name        ? '<div class="tag-meta">üë§ ' + tag.owner_name + '</div>' : ''),
            (tag.emergency_contact ? '<div class="tag-meta">üìû ' + tag.emergency_contact + '</div>' : ''),
            (tag.pet_name          ? '<div class="tag-meta">üêæ ' + tag.pet_name + (tag.pet_breed ? ' &mdash; ' + tag.pet_breed : '') + '</div>' : ''),
            '<div class="tag-date">Added: ' + new Date(tag.created_at).toLocaleDateString('en-IN', {day:'2-digit',month:'short',year:'numeric'}) + '</div>',
            '<div class="tag-actions">',
              '<button class="act-btn act-btn-primary" onclick="viewQR('' + tag.tag_code + '')">üîç View QR</button>',
              '<button class="act-btn act-btn-outline" onclick="copyTagLink('' + tag.tag_code + '')">üîó Copy Link</button>',
              '<button class="act-btn act-btn-outline" onclick="toggleContact(' + tag.id + ',' + (!tag.is_contactable) + ')">',
                (tag.is_contactable ? 'üôà Hide' : 'üëÅ Show'),
              '</button>',
            '</div>',
          '</div>',
        '</div>'
      ].join('');
    }).join('');

    // Trigger QR loading for all tags
    data.tags.forEach(tag => loadQRCode(tag.tag_code));

  } catch(e) {
    loading.style.display = 'block';
    if (e.name === 'AbortError') {
      loadMsg.innerHTML = '‚ö†Ô∏è Server took too long. It may still be starting up.<br>'
        + '<small style="color:#9ca3af;">Click Retry in ~20 seconds</small>';
    } else {
      loadMsg.innerHTML = '‚ùå ' + e.message;
    }
  }
}

function viewQR(tagCode) {
  if (qrCache[tagCode]) {
    openQRModal(tagCode, qrCache[tagCode]);
  } else {
    loadQRCode(tagCode);
    showToast('Loading QR...', 'info');
  }
}

// ---- Fetch Billing Plan ----
async function fetchBillingPlan() {
  const token = localStorage.getItem('token');
  if (!token) return;
  try {
    const res  = await fetch(API_URL + '/billing/plan', {
      headers: { Authorization: 'Bearer ' + token }
    });
    const data = await res.json();
    if (data.success && data.plan && data.plan.subscription_tier && data.plan.subscription_tier !== 'basic') {
      const expiry = data.plan.subscription_expiry
        ? new Date(data.plan.subscription_expiry).toLocaleDateString('en-IN', {day:'2-digit',month:'short',year:'numeric'})
        : 'N/A';
      document.getElementById('plan-name-display').innerText   = data.plan.subscription_tier.toUpperCase() + ' Plan';
      document.getElementById('plan-expiry-display').innerText = 'Valid until ' + expiry;
      document.getElementById('plan-card').style.display       = 'flex';
      document.getElementById('no-plan').style.display         = 'none';
    }
  } catch(e) { /* silently fail ‚Äî billing is non-critical */ }
}

// ---- Delete Account Confirm ----
function confirmDelete() {
  if (confirm('‚ö†Ô∏è This will permanently delete your account and ALL your tags.\n\nThis cannot be undone. Are you sure?')) {
    showToast('Account deletion coming soon. Contact support for now.', 'info');
  }
}

// ---- Toast Notifications ----
function showToast(msg, type) {
  const existing = document.getElementById('ck-toast');
  if (existing) existing.remove();
  const colors = { success:'#10b981', error:'#ef4444', info:'#2563eb' };
  const toast = document.createElement('div');
  toast.id = 'ck-toast';
  toast.style.cssText =
    'position:fixed;bottom:24px;right:24px;z-index:99999;'
    + 'background:' + (colors[type]||'#374151') + ';'
    + 'color:#fff;padding:12px 20px;border-radius:10px;font-weight:600;font-size:.875rem;'
    + 'box-shadow:0 8px 24px rgba(0,0,0,.2);'
    + 'animation:tabFadeIn .3s ease;max-width:300px;line-height:1.4;';
  toast.innerText = msg;
  document.body.appendChild(toast);
  setTimeout(() => { toast.style.opacity='0'; toast.style.transition='opacity .4s'; setTimeout(()=>toast.remove(),400); }, 3000);
}

// ---- On DOMContentLoaded ----
document.addEventListener('DOMContentLoaded', function() {
  fetchMyTags();
});
</script>

</body>
</html>