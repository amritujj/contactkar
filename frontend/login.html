<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login / Sign Up - ContactKar</title>
    <link rel="stylesheet" href="styles_v2.css">
    <style>
        .switch-form { text-align: center; margin-top: 1.5rem; color: #666; cursor: pointer; }
        .switch-form span { color: var(--primary); font-weight: bold; text-decoration: underline; }
        #signup-fields { display: none; } /* Hidden by default */
        .error-message { color: var(--danger); text-align: center; margin-bottom: 1rem; display: none; font-weight: bold;}
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="nav-brand">Contact<span>Kar</span></a>
        </div>
    </nav>

    <div class="auth-container">
        <h2 class="form-title" id="form-title">Welcome Back</h2>
        
        <div id="error-msg" class="error-message"></div>

        <form id="auth-form" onsubmit="handleAuth(event)">
            
            <!-- Signup Only Fields -->
            <div id="signup-fields">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="name" class="form-input" placeholder="Rahul Sharma">
                </div>
            </div>

            <!-- Common Fields -->
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="email" class="form-input" placeholder="you@example.com" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" class="form-input" placeholder="••••••••" required minlength="6">
            </div>
            
            <button type="submit" id="submit-btn" class="btn btn-primary" style="width: 100%;">Login</button>
        </form>

        <p class="switch-form" onclick="toggleMode()">
            <span id="switch-text">Don't have an account? Sign up here.</span>
        </p>
    </div>

    <script>
        // Make sure this matches your Render URL!
        const API_URL = "https://contactkar.onrender.com/api";
        
        let isLoginMode = true;

        function toggleMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('form-title').innerText = isLoginMode ? "Welcome Back" : "Create Account";
            document.getElementById('submit-btn').innerText = isLoginMode ? "Login" : "Sign Up";
            document.getElementById('switch-text').innerText = isLoginMode ? "Don't have an account? Sign up here." : "Already have an account? Login here.";
            document.getElementById('signup-fields').style.display = isLoginMode ? "none" : "block";
            
            // Require name only if signing up
            document.getElementById('name').required = !isLoginMode;
            document.getElementById('error-msg').style.display = "none"; // Clear errors
        }

        async function handleAuth(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const errorBox = document.getElementById('error-msg');
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('name').value;

            btn.innerText = "Please wait...";
            btn.disabled = true;
            errorBox.style.display = "none";

            const endpoint = isLoginMode ? "/auth/login" : "/auth/register";
            const payload = isLoginMode ? { email, password } : { email, password, name };

            try {
                const response = await fetch(API_URL + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    // Save real token and user data from Render backend
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('userName', data.user.name);
                    
                    // Go to dashboard
                    window.location.href = 'dashboard.html';
                } else {
                    // Show error from backend (e.g., "Email already exists" or "Wrong password")
                    errorBox.innerText = data.error || "Authentication failed";
                    errorBox.style.display = "block";
                    btn.innerText = isLoginMode ? "Login" : "Sign Up";
                    btn.disabled = false;
                }
            } catch (error) {
                errorBox.innerText = "Server error. Please try again later.";
                errorBox.style.display = "block";
                btn.innerText = isLoginMode ? "Login" : "Sign Up";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
